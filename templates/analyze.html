{% extends "template.html" %}
{% block title %}Analyze{% endblock title %}
{% block pageTitle %}Analysis{% endblock pageTitle %}
{% block navLink %}analyze{% endblock navLink %}

{% block body %}
  {{ super() }}
  <h5>View Usage Guide <a href="https://docs.google.com/document/d/1owFsCKhDUvF7T9SCQJTIQ-c1gQV6KgiIxk-d9Ufn7o4/edit?usp=sharing">Here</a>.</h5>
  <div class="text-center mb-3">
    <div class="btn-group justify-content-center" role="group" aria-label="Basic radio toggle button group">
      <input type="radio" class="btn-check" name="btnradio" id="autosearch" autocomplete="off" onclick="showAutomatic()">
      <label class="btn btn-outline-primary" for="autosearch">Automatic Searching</label>
      <input type="radio" class="btn-check" name="btnradio" id="manualsearch" autocomplete="off" onclick="showManual()">
      <label class="btn btn-outline-primary" for="manualsearch">Manual Searching</label>
    </div>
  </div>
  <form method="POST" action="" enctype="multipart/form-data" id="automaticForm" class="needs-validation" novalidate>
    {{ automaticForm.hidden_tag() }}
    <div class="form-group">
        {{ automaticForm.query.label(class="form-control-label") }}
        {% if automaticForm.query.errors %}
            {{ automaticForm.query(class="form-control is-invalid") }}
                {% for error in automaticForm.query.errors %}
                    <span class="invalid-feedback">{{ error }}</span>
                {% endfor %}
        {% else %}
            <div class="input-group mb-3">
              {{ automaticForm.query(class="form-control form-control-lg") }}
              {{ automaticForm.submit1(class="btn btn-primary btn-lg") }}
            </div>
        {% endif %}
        <div class="mb-4 text-center">
          <label class="form-control-label mb-1" for="categories">Categories: </label>
          <button type="button" class="btn btn-outline-secondary btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#category-modal">Open Category Modal</button>
          <div class="d-none" id="categories">
            {{ automaticForm.literature(class="btn-check", id="literature") }}
            {{ automaticForm.science(class="btn-check", id="science") }}
            {{ automaticForm.fineArts(class="btn-check", id="fineArts") }}
            {{ automaticForm.history(class="btn-check", id="history") }}
            {{ automaticForm.currentEvents(class="btn-check", id="currentEvents") }}
            {{ automaticForm.geography(class="btn-check", id="geography") }}
            {{ automaticForm.religion(class="btn-check", id="religion") }}
            {{ automaticForm.mythology(class="btn-check", id="mythology") }}
            {{ automaticForm.philosophy(class="btn-check", id="philosophy") }}
            {{ automaticForm.socialScience(class="btn-check", id="socialScience") }}
            {{ automaticForm.otherAcademic(class="btn-check", id="otherAcademic") }}
            {{ automaticForm.trash(class="btn-check", id="trash") }}
          </div>
          <label class="form-control-label mb-1 mt-2 d-none" for="subcategories">Subcategories: </label>
          <div class="d-none" id="subcategories">
            {{ automaticForm.americanLit(class="btn-check", id="americanLit") }}
            {{ automaticForm.britishLit(class="btn-check", id="britishLit") }}
            {{ automaticForm.classicalLit(class="btn-check", id="classicalLit") }}
            {{ automaticForm.europeanLit(class="btn-check", id="europeanLit") }}
            {{ automaticForm.worldLit(class="btn-check", id="worldLit") }}
            {{ automaticForm.otherLit(class="btn-check", id="otherLit") }}
            {{ automaticForm.biology(class="btn-check", id="biology") }}
            {{ automaticForm.chemistry(class="btn-check", id="chemistry") }}
            {{ automaticForm.physics(class="btn-check", id="physics") }}
            {{ automaticForm.math(class="btn-check", id="math") }}
            {{ automaticForm.otherSci(class="btn-check", id="otherSci") }}
            {{ automaticForm.visualFA(class="btn-check", id="visualFA") }}
            {{ automaticForm.auditoryFA(class="btn-check", id="auditoryFA") }}
            {{ automaticForm.otherFA(class="btn-check", id="otherFA") }}
            {{ automaticForm.americanHis(class="btn-check", id="americanHis") }}
            {{ automaticForm.ancientHis(class="btn-check", id="ancientHis") }}
            {{ automaticForm.europeanHis(class="btn-check", id="europeanHis") }}
            {{ automaticForm.worldHis(class="btn-check", id="worldHis") }}
            {{ automaticForm.otherHis(class="btn-check", id="otherHis") }}
          </div>
          <input type="hidden" name="alternateSubcategories" id="alternateSubcategoriesField" value="">
          <input type="hidden" name="categories" id="categoriesField" value="">
          <input type="hidden" name="subcategories" id="subcategoriesField" value="">
          
        </div>

        {{ automaticForm.difficulty.label(class="form-control-label") }}
            {% if automaticForm.difficulty.errors %}
                {{ automaticForm.difficulty(class="form-control is-invalid") }}
                    {% for error in automaticForm.difficulty.errors %}
                        <span class="invalid-feedback">{{ error }}</span>
                    {% endfor %}
            {% else %}
                {{ automaticForm.difficulty(class="form-control mb-4") }}
            {% endif %}

        {% if automaticForm.analyzeDetails.automatic.errors %}
            {{ automaticForm.analyzeDetails.automatic(class="form-control is-invalid") }}
                {% for error in automaticForm.analyzeDetails.automatic.errors %}
                    <span class="invalid-feedback">{{ error }}</span>
                {% endfor %}
            </div>
        {% else %}
            {{ automaticForm.analyzeDetails.automatic(class="form-check-input mb-3", type="checkbox", id="automatic.analyzeDetails.automatic") }}
        {% endif %}
        {{ automaticForm.analyzeDetails.automatic.label(class="form-check-label me-3") }}
      
        <div class="ms-5 mb-4">
          <div id="automatic automatic group">
            {{ automaticForm.analyzeDetails.maxResults.label(class="form-control-label") }}
            {% if automaticForm.analyzeDetails.maxResults.errors %}
                {{ automaticForm.analyzeDetails.maxResults(class="form-control is-invalid") }}
                    {% for error in automaticForm.analyzeDetails.maxResults.errors %}
                        <span class="invalid-feedback">{{ error }}</span>
                    {% endfor %}
            {% else %}
                {{ automaticForm.analyzeDetails.maxResults(class="form-control mb-3") }}
            {% endif %}
          </div>
          <div id="automatic nonautomatic group">
            {{ automaticForm.analyzeDetails.unigramNum.label(class="form-control-label") }}
            {% if automaticForm.analyzeDetails.unigramNum.errors %}
                {{ automaticForm.analyzeDetails.unigramNum(class="form-control is-invalid") }}
                    {% for error in automaticForm.analyzeDetails.unigramNum.errors %}
                        <span class="invalid-feedback">{{ error }}</span>
                    {% endfor %}
            {% else %}
                {{ automaticForm.analyzeDetails.unigramNum(class="form-control mb-3") }}
            {% endif %}

            {{ automaticForm.analyzeDetails.bigramFreq.label(class="form-control-label") }}
            {% if automaticForm.analyzeDetails.bigramFreq.errors %}
                {{ automaticForm.analyzeDetails.bigramFreq(class="form-control is-invalid") }}
                    {% for error in automaticForm.analyzeDetails.bigramFreq.errors %}
                        <span class="invalid-feedback">{{ error }}</span>
                    {% endfor %}
            {% else %}
                {{ automaticForm.analyzeDetails.bigramFreq(class="form-control mb-3") }}
            {% endif %}

            {{ automaticForm.analyzeDetails.trigramFreq.label(class="form-control-label") }}
            {% if automaticForm.analyzeDetails.trigramFreq.errors %}
                {{ automaticForm.analyzeDetails.trigramFreq(class="form-control is-invalid") }}
                    {% for error in automaticForm.analyzeDetails.trigramFreq.errors %}
                        <span class="invalid-feedback">{{ error }}</span>
                    {% endfor %}
            {% else %}
                {{ automaticForm.analyzeDetails.trigramFreq(class="form-control mb-3") }}
            {% endif %}

            {{ automaticForm.analyzeDetails.quadgramFreq.label(class="form-control-label") }}
            {% if automaticForm.analyzeDetails.quadgramFreq.errors %}
                {{ automaticForm.analyzeDetails.quadgramFreq(class="form-control is-invalid") }}
                    {% for error in automaticForm.analyzeDetails.quadgramFreq.errors %}
                        <span class="invalid-feedback">{{ error }}</span>
                    {% endfor %}
            {% else %}
                {{ automaticForm.analyzeDetails.quadgramFreq(class="form-control mb-3") }}
            {% endif %}
          </div>
        </div>
    </div>
  </form>
  <!-- Category Modal (qbreader-style) -->
  <div class="modal modal-lg" id="category-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title me-2">Select Categories</h5>
          <button type="button" class="btn btn-primary btn-sm me-2" id="toggle-all">Toggle all</button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-4" id="modal-categories">
              <h5 class="text-center">Category</h5>
              <!-- Filled by script -->
            </div>
            <div class="col-4" id="modal-subcategories">
              <h5 class="text-center">Subcategory</h5>
              <!-- Filled by script -->
            </div>
            <div class="col-4" id="modal-alt-subcategories">
              <h5 class="text-center">Alternate <span class="d-none d-lg-inline">Subcategory</span></h5>
              <!-- Filled by script -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <form method="POST" action="" enctype="multipart/form-data" id="manualForm" class="needs-validation" novalidate>
    {{ manualForm.hidden_tag() }}
    <div class="form-group">
        {{ manualForm.jsonFile.label(class="form-control-label") }}
        {% if manualForm.jsonFile.errors %}
            {{ manualForm.jsonFile(class="form-control is-invalid") }}
                {% for error in manualForm.jsonFile.errors %}
                    <span class="invalid-feedback">{{ error }}</span>
                {% endfor %}
        {% else %}
            {{ manualForm.jsonFile(class="form-control mb-3") }}
        {% endif %}
      
        {% if manualForm.analyzeDetails.automatic.errors %}
            {{ manualForm.analyzeDetails.automatic(class="form-control is-invalid") }}
                {% for error in manualForm.analyzeDetails.automatic.errors %}
                    <span class="invalid-feedback">{{ error }}</span>
                {% endfor %}
            </div>
        {% else %}
            {{ manualForm.analyzeDetails.automatic(class="form-check-input mb-3", type="checkbox", id="manual.analyzeDetails.automatic") }}
        {% endif %}
        {{ manualForm.analyzeDetails.automatic.label(class="form-check-label me-3") }}
      
        <div class="ms-5">
          <div id="manual automatic group">
            {{ manualForm.analyzeDetails.maxResults.label(class="form-control-label") }}
            {% if manualForm.analyzeDetails.maxResults.errors %}
                {{ manualForm.analyzeDetails.maxResults(class="form-control is-invalid") }}
                    {% for error in manualForm.analyzeDetails.maxResults.errors %}
                        <span class="invalid-feedback">{{ error }}</span>
                    {% endfor %}
            {% else %}
                {{ manualForm.analyzeDetails.maxResults(class="form-control mb-3") }}
            {% endif %}
          </div>
          <div id="manual nonautomatic group">
            {{ manualForm.analyzeDetails.unigramNum.label(class="form-control-label") }}
            {% if manualForm.analyzeDetails.unigramNum.errors %}
                {{ manualForm.analyzeDetails.unigramNum(class="form-control is-invalid") }}
                    {% for error in manualForm.analyzeDetails.unigramNum.errors %}
                        <span class="invalid-feedback">{{ error }}</span>
                    {% endfor %}
            {% else %}
                {{ manualForm.analyzeDetails.unigramNum(class="form-control mb-3") }}
            {% endif %}

            {{ manualForm.analyzeDetails.bigramFreq.label(class="form-control-label") }}
            {% if manualForm.analyzeDetails.bigramFreq.errors %}
                {{ manualForm.analyzeDetails.bigramFreq(class="form-control is-invalid") }}
                    {% for error in manualForm.analyzeDetails.bigramFreq.errors %}
                        <span class="invalid-feedback">{{ error }}</span>
                    {% endfor %}
            {% else %}
                {{ manualForm.analyzeDetails.bigramFreq(class="form-control mb-3") }}
            {% endif %}

            {{ manualForm.analyzeDetails.trigramFreq.label(class="form-control-label") }}
            {% if manualForm.analyzeDetails.trigramFreq.errors %}
                {{ manualForm.analyzeDetails.trigramFreq(class="form-control is-invalid") }}
                    {% for error in manualForm.analyzeDetails.trigramFreq.errors %}
                        <span class="invalid-feedback">{{ error }}</span>
                    {% endfor %}
            {% else %}
                {{ manualForm.analyzeDetails.trigramFreq(class="form-control mb-3") }}
            {% endif %}

            {{ manualForm.analyzeDetails.quadgramFreq.label(class="form-control-label") }}
            {% if manualForm.analyzeDetails.quadgramFreq.errors %}
                {{ manualForm.analyzeDetails.quadgramFreq(class="form-control is-invalid") }}
                    {% for error in manualForm.analyzeDetails.quadgramFreq.errors %}
                        <span class="invalid-feedback">{{ error }}</span>
                    {% endfor %}
            {% else %}
                {{ manualForm.analyzeDetails.quadgramFreq(class="form-control mb-3") }}
            {% endif %}
          </div>
        </div>
    </div>
    <div class="text-center">
      {{ manualForm.submit2(class="btn btn-primary btn-lg mt-2") }}
    </div>
  </form>
{% endblock body %}

{% block results %}
{{ super() }}
{% block results_inner %}
{% if data != None %}
{% if noResults %}
<h3 class="text-center">No Questions matched Query.</h3>
{% else %}
<div id="data">
  <h5 class="lead text-center">If any clues are not properly filtered, namely they are just parts of the standard Quizbowl canon, please submit them to this <a href="https://forms.gle/3iiSSbspPfuEDvTe7">form</a>.</h5>
  <h5 class="lead text-center mb-4">Copy any clue by simply clicking on the clue card!</h5>
  <div class="text-center">
  <h3>Unigrams Clues (By Frequency): </h3>
  {% if data[0] %}
  <div class="row g-4 text-center justify-content-center mb-4">
    {% for e in data[0] %}
    <div class="col-sm-2">
      <div class="card h-100" title="Copy!" data-bs-trigger="click" onclick="ngramClick(this, '{{e}}')">
        <div class="card-body">
          <p class="card-text">{{e}}</p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="text-center">
  <button type="button" class="btn btn-primary mb-3 w-50" onclick="copyToClipboard(String.raw`{{data[4][0]}}`);">Copy Unigrams</button>
  </div>
  {% else %}
  <h5>No unigrams found!</h5>
  {% endif %}
  <h3 class="mt-3">Bigrams Clues (By PMI Score): </h3>
  {% if data[1] %}
  <div class="row g-4 text-center justify-content-center mb-4">
    {% for e in data[1] %}
    <div class="col-sm-2">
      <div class="card h-100" title="Copy!" data-bs-trigger="click" onclick="ngramClick(this, '{{e}}')">
        <div class="card-body">
          <p class="card-text">{{e}}</p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="text-center">
  <button type="button" class="btn btn-primary mb-3 w-50" onclick="copyToClipboard(String.raw`{{data[4][1]}}`);">Copy Bigrams</button>
  </div>
  {% else %}
  <h5>No bigrams found!</h5>
  {% endif %}
  <h3 class="mt-3">Trigrams Clues (By PMI Score): </h3>
  {% if data[2] %}
  <div class="row g-4 text-center justify-content-center mb-4">
    {% for e in data[2] %}
    <div class="col-sm-2">
      <div class="card h-100" title="Copy!" data-bs-trigger="click" onclick="ngramClick(this, '{{e}}')">
        <div class="card-body">
          <p class="card-text">{{e}}</p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="text-center">
  <button type="button" class="btn btn-primary mb-3 w-50" onclick="copyToClipboard(String.raw`{{data[4][2]}}`);">Copy Trigrams</button>
  </div>
  {% else %}
  <h5>No Trigrams found!</h5>
  {% endif %}
  <h3 class="mt-3">Quadgrams Clues (By PMI Score): </h3>
  {% if data[3] %}
  <div class="row g-4 text-center justify-content-center mb-4">
    {% for e in data[3] %}
    <div class="col-sm-2">
      <div class="card h-100" title="Copy!" data-bs-trigger="click" onclick="ngramClick(this, '{{e}}')">
        <div class="card-body">
          <p class="card-text">{{e}}</p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="text-center">
  <button type="button" class="btn btn-primary mb-3 w-50" onclick="copyToClipboard(String.raw`{{data[4][3]}}`);">Copy Quadgrams</button>
  </div>
  {% else %}
  <h5>No quadgrams found!</h5>
  {% endif %}
  </div>
</div>
<h3 class="mt-3">Questions: </h3>
<p class="text-muted m-2"><b>{{questions.__len__()}} Questions Found</b></p>
{% for t in questions %}
<div class="card m-2 mb-4">
    <div class="card-header">
        <b class="card-title">{{t['setName']}} | {{t['category']}} | {{t['subcategory']}} | {{t['difficulty']}}</b>
    </div>
    <div class="card-body">
        <ul class="list-group list-group-flush">
            <li class="list-group-item">
                {{t['question']}}
            </li>
            {% if 'formatted_answer' in t %}
            <li class="list-group-item">Answer: {{t['formatted_answer']|safe}}</li>
            {% else %}
            <li class="list-group-item">Answer: {{t['answer']}}</li>
            {% endif %}
        </ul>
    </div>
</div>
{% endfor %}
{% endif %}
{% endif %}
{% endblock results_inner %}
{% endblock results %}

{% block script %}
  <script>
    // --- QBReader-like Category Modal ---
    const CATEGORY_BUTTONS = [
      ['Literature', 'primary'],
      ['History', 'success'],
      ['Science', 'danger'],
      ['Fine Arts', 'warning'],
      ['Religion', 'secondary'],
      ['Mythology', 'secondary'],
      ['Philosophy', 'secondary'],
      ['Social Science', 'secondary'],
      ['Current Events', 'secondary'],
      ['Geography', 'secondary'],
      ['Other Academic', 'secondary'],
      ['Pop Culture', 'secondary']
    ];
    const SUBCATEGORY_BUTTONS = [
      ['American Literature', 'primary'],
      ['British Literature', 'primary'],
      ['Classical Literature', 'primary'],
      ['European Literature', 'primary'],
      ['World Literature', 'primary'],
      ['Other Literature', 'primary'],
      ['American History', 'success'],
      ['Ancient History', 'success'],
      ['European History', 'success'],
      ['World History', 'success'],
      ['Other History', 'success'],
      ['Biology', 'danger'],
      ['Chemistry', 'danger'],
      ['Physics', 'danger'],
      ['Other Science', 'danger'],
      ['Visual Fine Arts', 'warning'],
      ['Auditory Fine Arts', 'warning'],
      ['Other Fine Arts', 'warning'],
      ['Movies', 'secondary'],
      ['Music', 'secondary'],
      ['Sports', 'secondary'],
      ['Television', 'secondary'],
      ['Video Games', 'secondary'],
      ['Other Pop Culture', 'secondary']
    ];
    const ALTERNATE_SUBCATEGORY_BUTTONS = [
      ['Drama', 'primary'],
      ['Long Fiction', 'primary'],
      ['Poetry', 'primary'],
      ['Short Fiction', 'primary'],
      ['Misc Literature', 'primary'],
      ['Math', 'danger'],
      ['Astronomy', 'danger'],
      ['Computer Science', 'danger'],
      ['Earth Science', 'danger'],
      ['Engineering', 'danger'],
      ['Misc Science', 'danger'],
      ['Architecture', 'warning'],
      ['Dance', 'warning'],
      ['Film', 'warning'],
      ['Jazz', 'warning'],
      ['Musicals', 'warning'],
      ['Opera', 'warning'],
      ['Photography', 'warning'],
      ['Misc Arts', 'warning'],
      ['Anthropology', 'secondary'],
      ['Economics', 'secondary'],
      ['Linguistics', 'secondary'],
      ['Psychology', 'secondary'],
      ['Sociology', 'secondary'],
      ['Other Social Science', 'secondary']
    ];

    function renderCategoryModal() {
      const catRoot = document.getElementById('modal-categories');
      const subRoot = document.getElementById('modal-subcategories');
      const altRoot = document.getElementById('modal-alt-subcategories');
      if (!catRoot || !subRoot || !altRoot) return;

      const safeId = (label) => label.replace(/[^a-zA-Z0-9]+/g, '-');
      const makeBtn = (id, label, color) => `
        <div>
          <input type="checkbox" class="btn-check" autocomplete="off" id="modal-${safeId(id)}">
          <label class="btn btn-outline-${color} w-100 rounded-0 my-1" for="modal-${safeId(id)}">${label}<br/></label>
        </div>`;

      // Fill columns
      let html = '<h5 class="text-center">Category</h5>';
      CATEGORY_BUTTONS.forEach(([label, color]) => {
        html += makeBtn(label, label, color);
      });
      catRoot.innerHTML = html;

      html = '<h5 class="text-center">Subcategory</h5>';
      SUBCATEGORY_BUTTONS.forEach(([label, color]) => {
        html += makeBtn(label, label, color);
      });
      subRoot.innerHTML = html;

      html = '<h5 class="text-center">Alternate <span class="d-none d-lg-inline">Subcategory</span></h5>';
      ALTERNATE_SUBCATEGORY_BUTTONS.forEach(([label, color]) => {
        html += makeBtn(label, label, color);
      });
      altRoot.innerHTML = html;

      // Sync checked state with main form
      function syncFromForm() {
        const setChecked = (label, checked) => {
          const el = document.getElementById(`modal-${safeId(label)}`);
          if (el) el.checked = checked;
        };
        Object.entries(categoryMap).forEach(([label, id]) => {
          const formEl = document.getElementById(id);
          if (formEl) setChecked(label, formEl.checked);
        });
        Object.entries(subMap).forEach(([label, id]) => {
          const formEl = document.getElementById(id);
          if (formEl) setChecked(label, formEl.checked);
        });
        // Alternate subcategories: read from hidden field
        const selectedAlt = new Set((altField?.value || '').split(',').map(s => s.trim()).filter(Boolean));
        ALTERNATE_SUBCATEGORY_BUTTONS.forEach(([label]) => setChecked(label, selectedAlt.has(label)));
      }

      function bindHandlers() {
        const toggle = (label, id) => {
          const modalEl = document.getElementById(`modal-${safeId(label)}`);
          const formEl = document.getElementById(id);
          if (modalEl && formEl) {
            modalEl.addEventListener('change', () => {
              formEl.checked = modalEl.checked;
              updateCategoryAndSubcategoryFields();
            });
          }
        };
        Object.entries(categoryMap).forEach(([label, id]) => toggle(label, id));
        // When categories are toggled, cascade to subcategories like original logic
        const handleCategoryCascade = (categoryLabel) => {
          const modalEl = document.getElementById(`modal-${safeId(categoryLabel)}`);
          if (!modalEl) return;
          const targets = cascadeMap[categoryLabel] || [];
          targets.forEach(lbl => {
            const modalSub = document.getElementById(`modal-${safeId(lbl)}`);
            if (modalSub) modalSub.checked = modalEl.checked;
            const formId = subMap[lbl];
            if (formId) {
              const formEl = document.getElementById(formId);
              if (formEl) formEl.checked = modalEl.checked;
            }
          });
          const altTargets = cascadeMapAlt[categoryLabel] || [];
          altTargets.forEach(lbl => {
            const modalAlt = document.getElementById(`modal-${safeId(lbl)}`);
            if (modalAlt) {
              modalAlt.checked = modalEl.checked;
              modalAlt.dispatchEvent(new Event('change'));
            }
          });
        };
        // Bind base subcategory toggles
        Object.entries(subMap).forEach(([label, id]) => toggle(label, id));
        // Extend category toggles to cascade and update hidden fields
        Object.keys(cascadeMap).forEach(categoryLabel => {
          const catEl = document.getElementById(`modal-${safeId(categoryLabel)}`);
          if (catEl) {
            catEl.addEventListener('change', () => {
              handleCategoryCascade(categoryLabel);
              // Update hidden fields for categories/subcategories
              const selectedCats = [];
              Object.keys(categoryMap).forEach((label) => {
                const el = document.getElementById(`modal-${safeId(label)}`);
                if (el?.checked) selectedCats.push(label);
              });
              const categoriesField = document.getElementById('categoriesField');
              if (categoriesField) categoriesField.value = selectedCats.join(',');
              const selectedSubs = [];
              Object.keys(subMap).forEach((label) => {
                const el = document.getElementById(`modal-${safeId(label)}`);
                if (el?.checked) selectedSubs.push(label);
              });
              const subcategoriesField = document.getElementById('subcategoriesField');
              if (subcategoriesField) subcategoriesField.value = selectedSubs.join(',');
            });
          }
        });

        // Alternate subcategory toggles -> write to hidden field and ensure parent category checked when needed
        const altField = document.getElementById('alternateSubcategoriesField');
        const altToCategory = (() => {
          const m = {};
          Object.entries(cascadeMapAlt).forEach(([cat, arr]) => arr.forEach(a => m[a] = cat));
          return m;
        })();
        function updateAltField() {
          const selected = [];
          ALTERNATE_SUBCATEGORY_BUTTONS.forEach(([label]) => {
            const el = document.getElementById(`modal-${safeId(label)}`);
            if (el?.checked) selected.push(label);
          });
          if (altField) altField.value = selected.join(',');
        }
        ALTERNATE_SUBCATEGORY_BUTTONS.forEach(([label]) => {
          const el = document.getElementById(`modal-${safeId(label)}`);
          if (el) el.addEventListener('change', () => {
            // ensure parent category checked if any alternate is checked
            const parent = altToCategory[label];
            if (parent) {
              const modalCat = document.getElementById(`modal-${safeId(parent)}`);
              const formCatIdMap = {
                'Literature': 'literature', 'Science': 'science', 'Fine Arts': 'fineArts', 'History': 'history', 'Social Science': 'socialScience'
              };
              const formCat = document.getElementById(formCatIdMap[parent]);
              if (el.checked) {
                if (modalCat) modalCat.checked = true;
                if (formCat) formCat.checked = true;
              }
            }
            updateAltField();
          });
        });
        // initial field sync
        updateAltField();
        // categories/subcategories initial sync
        (function initCatSubFields(){
          const selectedCats = [];
          Object.keys(categoryMap).forEach((label) => {
            const el = document.getElementById(`modal-${safeId(label)}`);
            if (el?.checked) selectedCats.push(label);
          });
          const categoriesField = document.getElementById('categoriesField');
          if (categoriesField) categoriesField.value = selectedCats.join(',');
          const selectedSubs = [];
          Object.keys(subMap).forEach((label) => {
            const el = document.getElementById(`modal-${safeId(label)}`);
            if (el?.checked) selectedSubs.push(label);
          });
          const subcategoriesField = document.getElementById('subcategoriesField');
          if (subcategoriesField) subcategoriesField.value = selectedSubs.join(',');
        })();
      }

      syncFromForm();
      bindHandlers();

      const toggleAllBtn = document.getElementById('toggle-all');
      if (toggleAllBtn) {
        toggleAllBtn.onclick = () => {
          const anyUnchecked = CATEGORY_BUTTONS.some(([label]) => !document.getElementById(`modal-${safeId(label)}`)?.checked)
            || SUBCATEGORY_BUTTONS.some(([label]) => !document.getElementById(`modal-${safeId(label)}`)?.checked)
            || ALTERNATE_SUBCATEGORY_BUTTONS.some(([label]) => !document.getElementById(`modal-${safeId(label)}`)?.checked);
          const setAll = (checked) => ([_label]) => {
            const el = document.getElementById(`modal-${safeId(_label)}`);
            if (el) {
              el.checked = checked;
              el.dispatchEvent(new Event('change'));
            }
          };
          CATEGORY_BUTTONS.forEach(setAll(anyUnchecked));
          SUBCATEGORY_BUTTONS.forEach(setAll(anyUnchecked));
          ALTERNATE_SUBCATEGORY_BUTTONS.forEach(setAll(anyUnchecked));
          // reflect into form checkboxes
          document.getElementById('categories').querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = anyUnchecked);
          document.getElementById('subcategories').querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = anyUnchecked);
          // update hidden alt field
          const altField = document.getElementById('alternateSubcategoriesField');
          if (altField) {
            const selected = [];
            ALTERNATE_SUBCATEGORY_BUTTONS.forEach(([label]) => {
              const el = document.getElementById(`modal-${safeId(label)}`);
              if (el?.checked) selected.push(label);
            });
            altField.value = selected.join(',');
          }
        };
      }
    }

    // Build modal when shown
    document.addEventListener('shown.bs.modal', (e) => {
      if (e.target && e.target.id === 'category-modal') {
        renderCategoryModal();
      }
    });
    // Also rebuild state when the modal is about to hide to ensure hidden fields/checkboxes are up to date
    document.addEventListener('hide.bs.modal', (e) => {
      if (e.target && e.target.id === 'category-modal') {
        const altField = document.getElementById('alternateSubcategoriesField');
        if (altField) {
          const selected = [];
          const safeId = (label) => label.replace(/[^a-zA-Z0-9]+/g, '-');
          ALTERNATE_SUBCATEGORY_BUTTONS.forEach(([label]) => {
            const el = document.getElementById(`modal-${safeId(label)}`);
            if (el?.checked) selected.push(label);
          });
          altField.value = selected.join(',');
        }
      }
    });
    function loading() {
      const data = document.getElementById("data")
      if(data !== null){
        data.style.display = 'none';
      }
      const spinner = document.getElementById("loadSpinner");
      spinner.parentElement.style.display = 'block';
      spinner.style.display = 'block';
    }
    
    // Async submit with cancellation
    let currentController = null;
    async function submitWithAjax(form, fdOverride = null) {
      if (currentController) currentController.abort();
      currentController = new AbortController();
      try {
        const resp = await fetch(form.action || window.location.pathname, {
          method: 'POST',
          body: fdOverride || new FormData(form),
          signal: currentController.signal
        });
        const html = await resp.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const newResultsInner = doc.getElementById('resultsContent');
        const resultsInner = document.getElementById('resultsContent');
        if (newResultsInner && resultsInner) {
          resultsInner.innerHTML = newResultsInner.innerHTML;
          const spinner = document.getElementById("loadSpinner");
          if (spinner) spinner.style.display = 'none';
          document.getElementById("scrollTo")?.scrollIntoView({ behavior: 'smooth' });
          const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
          [...tooltipTriggerList].forEach(el => new bootstrap.Tooltip(el));
        }
      } catch (e) {
        if (e.name !== 'AbortError') console.error(e);
      } finally {
        currentController = null;
      }
    }

    // Validation + ajax hook
    (() => {
      const forms = document.querySelectorAll('.needs-validation')
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', async event => {
          event.preventDefault();
          event.stopPropagation();
          if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
          }
          // Ensure submit button name/value included (so backend sees submit1/submit2)
          const fd = new FormData(form);
          const submitter = event.submitter;
          if (submitter && submitter.name) {
            fd.append(submitter.name, submitter.value || '');
          } else {
            // Fallback: try common names
            const fallbackBtn = form.querySelector('button[type="submit"],input[type="submit"]');
            if (fallbackBtn && fallbackBtn.name) fd.append(fallbackBtn.name, fallbackBtn.value || '');
          }
          loading();
          await submitWithAjax(form, fd);
          form.classList.add('was-validated');
        }, false)
      })
    })()
    
    const automaticCheckbox = document.getElementById('automatic.analyzeDetails.automatic');
    const automaticAutomatic = document.getElementById('automatic automatic group');
    const automaticNonautomatic = document.getElementById('automatic nonautomatic group');

    function updateAutomaticForm() {
      if (automaticCheckbox.checked) {
        automaticAutomatic.style.display = 'block';
        automaticNonautomatic.style.display = 'none';
      } else {
        automaticAutomatic.style.display = 'none';
        automaticNonautomatic.style.display = 'block';
      }
    }
    updateAutomaticForm();
    
    automaticCheckbox.addEventListener('click', updateAutomaticForm);
    
    const manualCheckbox = document.getElementById('manual.analyzeDetails.automatic');
    const manualAutomatic = document.getElementById('manual automatic group');
    const manualNonautomatic = document.getElementById('manual nonautomatic group');

    function updateManualForm() {
      if (manualCheckbox.checked) {
        manualAutomatic.style.display = 'block';
        manualNonautomatic.style.display = 'none';
      } else {
        manualAutomatic.style.display = 'none';
        manualNonautomatic.style.display = 'block';
      }
    }
    updateManualForm();
    
    manualCheckbox.addEventListener('click', updateManualForm);

    function ngramClick(ele, message) {
      // Check if Shift key is down.
      if (window.event.shiftKey) {
        // Open a new analyze tab with the query as the ngram.
        // Send a POST request to the analyze page with the query as the ngram.
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/analyze';
        form.target = '_blank';
        form.style.display = 'none';
        const query = document.createElement('input');
        query.type = 'text';
        query.name = 'query';
        query.value = message;
        form.appendChild(query);
        const categories = document.createElement('input');
        categories.type = 'text';
        categories.name = 'categories';
        categories.value = 'all';
        form.appendChild(categories);
        const subcategories = document.createElement('input');
        subcategories.type = 'text';
        subcategories.name = 'subcategories';
        subcategories.value = 'all';
        form.appendChild(subcategories);
        const difficulty = document.createElement('input');
        difficulty.type = 'text';
        difficulty.name = 'difficulty';
        difficulty.value = '';
        form.appendChild(difficulty);
        const analyzeDetails = document.createElement('input'); 
        analyzeDetails.type = 'checkbox';
        analyzeDetails.name = 'analyzeDetails-automatic';
        analyzeDetails.checked = true;
        form.appendChild(analyzeDetails);
        const maxResults = document.createElement('input');
        maxResults.type = 'text';
        maxResults.name = 'analyzeDetails-maxResults';
        maxResults.value = '15';
        analyzeDetails.appendChild(maxResults);
        document.body.appendChild(form);
        form.submit();
        ele.setAttribute("data-bs-original-title", "Opened in new tab!");
      } else {
        copyToClipboard(String.raw`${message}`)
        ele.setAttribute("data-bs-original-title", "Copied!");
      }
    }

    // Removed click-to-copy question id to allow text selection
    const automaticForm = document.getElementById("automaticForm");
    const manualForm = document.getElementById("manualForm");
    function showAutomatic() {
      automaticForm.style.display = 'block';
      manualForm.style.display = 'none';
    }
    {% if showAutomatic %}
      showAutomatic();
      document.getElementById("autosearch").checked = true;
    {% else %}
      showManual();
      document.getElementById("manualsearch").checked = true;
    {% endif %}
    
    function showManual() {
      automaticForm.style.display = 'none';
      manualForm.style.display = 'block';
    }

    {% if data != None %}
      const spinner = document.getElementById("loadSpinner");
      spinner.style.display = 'none';
      document.getElementById("scrollTo").scrollIntoView();
    {% endif %}
  </script>
{% endblock script %}